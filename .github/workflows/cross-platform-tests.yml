name: Cross-Platform Tests

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'android/**'
      - 'ios/**'
      - 'bdd/**'
      - '.github/workflows/cross-platform-tests.yml'
  push:
    branches: [ main ]
    paths:
      - 'android/**'
      - 'ios/**'
      - 'bdd/**'

jobs:
  # Check if we need to run both platforms
  changes:
    runs-on: ubuntu-latest
    outputs:
      android: ${{ steps.changes.outputs.android }}
      ios: ${{ steps.changes.outputs.ios }}
      bdd: ${{ steps.changes.outputs.bdd }}
    steps:
    - uses: actions/checkout@v4
    - uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          android:
            - 'android/**'
          ios:
            - 'ios/**'
          bdd:
            - 'bdd/**'

  # Create unified report (always runs)
  unified-report:
    needs: changes
    runs-on: ubuntu-latest
    
    steps:
    - name: Create unified test report
      run: |
        echo "# ðŸŒ Cross-Platform Test Results" > unified-report.md
        echo "" >> unified-report.md
        echo "## YAML-Driven Cross-Platform Validation" >> unified-report.md
        echo "" >> unified-report.md
        echo "### Changes Detected:" >> unified-report.md
        
        if [ "${{ needs.changes.outputs.android }}" == "true" ]; then
          echo "- âœ… **Android** changes detected - Firebase Test Lab matrix will run" >> unified-report.md
        else
          echo "- â­ï¸ **Android** no changes" >> unified-report.md
        fi
        
        if [ "${{ needs.changes.outputs.ios }}" == "true" ]; then
          echo "- âœ… **iOS** changes detected - would run iOS tests" >> unified-report.md
        else
          echo "- â­ï¸ **iOS** no changes" >> unified-report.md
        fi
        
        if [ "${{ needs.changes.outputs.bdd }}" == "true" ]; then
          echo "- ðŸŽ¯ **YAML/BDD** specifications updated - both platforms should test" >> unified-report.md
        fi
        
        echo "" >> unified-report.md
        echo "### Firebase Test Lab Status" >> unified-report.md
        echo "- ðŸ“± **3-device matrix**: Pixel 2 API 28/30, Nexus Low Res API 29" >> unified-report.md
        echo "- ðŸ§ª **17 YAML scenarios**: Login validation, error handling, network tests" >> unified-report.md
        echo "- ðŸŽ¬ **Video recording**: Enabled for UI interaction capture" >> unified-report.md
        echo "" >> unified-report.md
        echo "---" >> unified-report.md
        echo "*Unified YAML specifications ensure consistent behavior across platforms* ðŸš€" >> unified-report.md

    - name: Upload unified report
      uses: actions/upload-artifact@v4
      with:
        name: unified-test-report
        path: unified-report.md

    - name: Comment PR with unified results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('unified-report.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: report
          });
