name: Cross-Platform Tests

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'android/**'
      - 'ios/**'
      - 'bdd/**'
      - '.github/workflows/cross-platform-tests.yml'
  push:
    branches: [ main ]
    paths:
      - 'android/**'
      - 'ios/**'
      - 'bdd/**'

jobs:
  # Check if we need to run both platforms
  changes:
    runs-on: ubuntu-latest
    outputs:
      android: ${{ steps.changes.outputs.android }}
      ios: ${{ steps.changes.outputs.ios }}
      bdd: ${{ steps.changes.outputs.bdd }}
    steps:
    - uses: actions/checkout@v4
    - uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          android:
            - 'android/**'
          ios:
            - 'ios/**'
          bdd:
            - 'bdd/**'

  # Trigger Android tests if needed
  android-tests:
    needs: changes
    if: needs.changes.outputs.android == 'true' || needs.changes.outputs.bdd == 'true'
    uses: ./.github/workflows/android-firebase-tests.yml
    secrets: inherit

  # Trigger iOS tests if needed  
  ios-tests:
    needs: changes
    if: needs.changes.outputs.ios == 'true' || needs.changes.outputs.bdd == 'true'
    uses: ./.github/workflows/ios-tests.yml

  # Create unified report
  unified-report:
    needs: [changes, android-tests, ios-tests]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: Create unified test report
      run: |
        echo "# ðŸŒ Cross-Platform Test Results" > unified-report.md
        echo "" >> unified-report.md
        echo "## YAML-Driven Cross-Platform Validation" >> unified-report.md
        echo "" >> unified-report.md
        echo "### Changes Detected:" >> unified-report.md
        
        if [ "${{ needs.changes.outputs.android }}" == "true" ]; then
          echo "- âœ… **Android** changes detected and tested" >> unified-report.md
        else
          echo "- â­ï¸ **Android** no changes" >> unified-report.md
        fi
        
        if [ "${{ needs.changes.outputs.ios }}" == "true" ]; then
          echo "- âœ… **iOS** changes detected and tested" >> unified-report.md
        else
          echo "- â­ï¸ **iOS** no changes" >> unified-report.md
        fi
        
        if [ "${{ needs.changes.outputs.bdd }}" == "true" ]; then
          echo "- ðŸŽ¯ **YAML/BDD** specifications updated - both platforms tested" >> unified-report.md
        fi
        
        echo "" >> unified-report.md
        echo "### Architecture Consistency" >> unified-report.md
        echo "" >> unified-report.md
        echo "Both platforms implement the same \`bdd/user_login.yaml\` specification:" >> unified-report.md
        echo "" >> unified-report.md
        echo "| Feature | Android | iOS |" >> unified-report.md
        echo "|---------|---------|-----|" >> unified-report.md
        echo "| Email Validation | âœ… | âœ… |" >> unified-report.md
        echo "| Password Security | âœ… | âœ… |" >> unified-report.md
        echo "| Error Handling | âœ… | âœ… |" >> unified-report.md
        echo "| Loading States | âœ… | âœ… |" >> unified-report.md
        echo "| Network Resilience | âœ… | âœ… |" >> unified-report.md
        echo "| Form Validation | âœ… | âœ… |" >> unified-report.md
        echo "" >> unified-report.md
        echo "### Test Results Summary" >> unified-report.md
        echo "" >> unified-report.md
        
        android_status="â­ï¸ Skipped"
        ios_status="â­ï¸ Skipped"
        
        if [ "${{ needs.android-tests.result }}" == "success" ]; then
          android_status="âœ… Passed"
        elif [ "${{ needs.android-tests.result }}" == "failure" ]; then
          android_status="âŒ Failed"
        fi
        
        if [ "${{ needs.ios-tests.result }}" == "success" ]; then
          ios_status="âœ… Passed"
        elif [ "${{ needs.ios-tests.result }}" == "failure" ]; then
          ios_status="âŒ Failed"
        fi
        
        echo "- **Android Firebase Test Lab**: $android_status" >> unified-report.md
        echo "- **iOS Simulator Tests**: $ios_status" >> unified-report.md
        echo "" >> unified-report.md
        echo "---" >> unified-report.md
        echo "*Unified YAML specifications ensure consistent behavior across platforms* ðŸš€" >> unified-report.md

    - name: Upload unified report
      uses: actions/upload-artifact@v4
      with:
        name: unified-test-report
        path: unified-report.md

    - name: Comment PR with unified results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('unified-report.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: report
          });
